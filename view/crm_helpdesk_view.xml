<?xml version="1.0" encoding="utf-8"?>
<openerp>

<data>

    <!-- Load css super mega wow! -->
    <template id="assets_backend" name="enhanced_hd_ticket assets" inherit_id="web.assets_backend">
        <xpath expr="." position="inside">
            <link rel="stylesheet" href="/enhanced_helpdesk/static/src/css/ticket.css"/>
            <script type="text/javascript" src="/enhanced_helpdesk/static/src/js/helpdesk.js"></script>
            
            <link rel="stylesheet" href="/enhanced_helpdesk/static/src/css/ticket_external.css" 
                  groups="enhanced_helpdesk.ticketing_external_user"/>
        </xpath>
    </template>
    
    <!-- socrascrivo vista tree per utenti helpdesk -->
    <record model="ir.ui.view" id="crm_helpdesk.crm_case_tree_view_helpdesk">
            <field name="name">CRM - Helpdesk Support Tree</field>
            <field name="model">crm.helpdesk</field>
            <field name="arch" type="xml">
                <tree string="Helpdesk Support Tree" 
                    fonts="bold:proxy_status_code in ('app','dlv')"
                    colors="black:proxy_status_code in ('wrk');blue:proxy_status_code in ('app', 'dlv');green:proxy_status_code in ('ok');grey:proxy_status_code in ('xx')">
                    <field name="id" string="ID" />
                    <field name="name" string="Oggetto" />
                    <field name="project_id" />
                    <field name="categ_id" />
                    <field name="priority"/>
                    <field name="ticket_status_id" />
                    <field name="task_points" attrs="{'invisible': [('task_points', '=', '0')]}" sum="Punti stimati" />
                    <field name="task_deadline" attrs="{'invisible': [('task_points', '=', '0')]}" />
                    <field name="proxy_status_code" invisible="1" />
                </tree>
            </field>
   </record>

    <!-- dichiaro kanban per utenti helpdesk -->
    <record id="enhanced_helpdesk_kanban" model="ir.ui.view">
        <field name="name">Enhanced HelpDesk Kanban</field>
        <field name="model">crm.helpdesk</field>
        <field name="arch" type="xml">
            <kanban default_order="priority desc" default_group_by="ticket_status_id" quick_create="false" edit="false">
                <field name="name" />
                <field name="project_id" />
                <field name="task_id" />
                <field name="task_points" />
                <field name="task_deadline" />
                <field name="ticket_status_id" />
                <field name="description" />
                <field name="request_id" />
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <p class="ticket_state">
                                    <field name="ticket_status_id"/>
                                    <field name="priority" widget="priority"/>
                                </p>
                                <p class="ticket_info" t-if="(record.request_id != undefined)" >
                                    <img t-att-src="kanban_image('res.users', 'image_small', record.request_id.raw_value)" t-att-title="record.request_id.value" width="24" height="24" class="oe_kanban_avatar"/>
                                    <field name="project_id"/>
                                    <field name="date" />
                                </p>
                               
                                <p class="ticket_title"><field name="display_name"/></p>
                                
                                 <p class="task_info" t-if="(record.task_points.raw_value > 0)">
                                    estimated points: <strong><field name="task_points" /></strong><br />
                                    deliver date: <strong><field name="task_deadline" /></strong><br />
                                </p>
                                
                                <div class="ticket_message_block">
                                    <t t-raw="record.description.raw_value" attrs="{'invisible': [('description', '=', False)]}" />
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- dichiaro form per utenti helpdesk -->
    <record id="enhanced_helpdesk_form" model="ir.ui.view">
        <field name="name">Enhanced HelpDesk Form</field>
        <field name="model">crm.helpdesk</field>
        <field name="groups_id" eval="[(4, [ref('enhanced_helpdesk.ticketing_external_user') ])]" /> 
        
        <field name="arch" type="xml">
            
            <field name="proxy_status_code" invisible="1" />
            
            <form string="Helpdesk Support">
                <header>
             
                    <field name="ticket_status_id" widget="statusbar" attrs="{'readonly':True}" statusbar_colors="{&quot;1&quot;:&quot;blue&quot;}" /> 
                    
                    <button name="ticket_approved" class="oe_highlight_green" string="Approve"
                            attrs="{'invisible': [('proxy_status_code', '!=', 'app')]}"  /> 
                    
                    <!--
                    <button name="ticket_quote_refused" class="oe_read_only" string="Reject" confirm="Are you sure you want to reject the quotation?"
                            attrs="{'invisible': [('proxy_status_code', '!=', 'app')]}"  />
                    -->
                    
                    <button name="ticket_completed" class="oe_highlight_green" string="Accept deliver"
                            attrs="{'invisible': [('proxy_status_code', '!=', 'dlv')]}"  /> 
                    
                    <button name="ticket_work_refused" class="oe_read_only" string="Reject work" confirm="Are you sure you want to reject the work?"
                            attrs="{'invisible': [('proxy_status_code', '!=', 'dlv')]}"  /> 
                    
                    <!--
                    <button name="ticket_deleted" class="" string="Cancel" confirm="Are you sure you want to cancel this ticket?"
                            attrs="{'invisible': ['|',('id', '=', False), ('proxy_status_code', 'in', ('wrk', 'dlv', 'ok', 'xx'))]}" />
                    -->
                    <button class="oe_read_only" type="action"
                            name="%(action_ticket_cancel)d"
                            string="Cancel"
                            context="{'default_ticket_id': id}" 
                            confirm="Are you sure you want to cancel this ticket?"
                            attrs="{'invisible': ['|',('id', '=', False), ('proxy_status_code', 'in', ('wrk', 'dlv', 'ok', 'xx'))]}"
                            />
                    
                    <button class="oe_read_only" type="action"
                            name="%(action_ticket_cancel)d"
                            string="Reject"
                            context="{'default_ticket_id': id}" 
                            confirm="Are you sure you want to reject the quotation?"
                            attrs="{'invisible': [('proxy_status_code', '!=', 'app')]}"
                            />
                    
                </header>
                
                <sheet string="Helpdesk Support">
                    <group col="4" class="oe_header">
                        
                        <h2 colspan="4" attrs="{'invisible': [('id', '=', False)]}">
                            <span>Ticket ID</span> #<field name="id" class="oe_inline" readonly="1" colspan="1" nolabel="1"/>
                        </h2>
                        
                        <field name="user_id" invisible="1" colspan="4"
                            context="{'default_groups_ref':
                                      ['base.group_user',
                                       'base.group_partner_manager',
                                       'base.group_sale_salesman_all_leads']}" />
                        
                        <field name="request_id" widget="selection" colspan="2" attrs="{'readonly': True}" context="{'show_email': True}" />
                        
                        <field name="date" attrs="{'readonly': True}" colspan="2" string="Data"/>
                        <field name="date_deadline" invisible="1" colspan="4"/>
                        <field name="email_from" invisible="1" />
                        <!--  Partner_id is required for annoying checking rules -->
                        <field name="partner_id" invisible="1"/>
                        <group colspan="2">
                             <field name="project_id" widget="selection" colspan="2" attrs="{'readonly': [('proxy_status_code', '!=', 'new')]}" />
                            
                             <field name="channel_id" invisible="1"/>
                             <field name="source" groups="enhanced_helpdesk.ticketing_support" attrs="{'readonly': [('id', '!=', False)]}"/>

                             <field name="task_id" groups="enhanced_helpdesk.ticketing_support" attrs="{'readonly': True}" action="action_view_portal_task"   />
                             <field name="task_points" string="Estimated points" attrs="{'readonly': True, 'invisible': ['|',('task_points', '=', 0),('task_id', '=', False)]}" />
			                 <field name="task_deadline" string="Deadline" attrs="{'readonly': True, 'invisible': ['|',('task_points', '=', 0),('task_id', '=', False)]}" />
                        </group>
                        
                        <group colspan="2">
                            <field name="categ_id" colspan="1"
                                domain="[('object_id.model', '=', 'crm.helpdesk')]"
                                context="{'object_name': 'crm.helpdesk'}"
                                widget="selection"
                                attrs="{'readonly': [('proxy_status_code', '!=', 'new')]}"/>

                            <field name="priority" widget="priority" colspan="1"
                                attrs="{'readonly': [('proxy_status_code', 'in', ('xx','ok','wrk','dlv','app'))]}"/>
                                 
                        </group>
                        
                        <separator string="Subject" colspan="4"/>
                        
                        <group colspan="4">
                            <field name="name" nolabel="1" colspan="4"
                                attrs="{'readonly': [('proxy_status_code', '!=', 'new')]}"/>
                        </group>
                        
                        <separator string="Description" colspan="4"/>
                        
                        <group colspan="4">
                            <field name="description" widget="html" nolabel="1" colspan="4"
                                attrs="{'readonly': [('proxy_status_code', '!=', 'new')]}"/>
                            <field name="related_ticket" nolabel="1" colspan="4" readonly="1"
                                    attrs="{'invisible': [('related_ticket', '=', False)]}"/>
                        </group>

                        <separator string="Attachment" colspan="4"/>
                        
                        <field name="attachment_ids" colspan="4" mode="kanban"
                                context="{'default_res_id':uid, 'default_res_model':'res.users'}"
                                nolabel="1"
                                attrs="{'readonly': [('proxy_status_code', 'in', ('xx','ok'))]}">
                            <form>
                                <field name="name" colspan="4" invisible="True"/>
                                <label for="datas" colspan="4"/>
                                <field name="datas" colspan="4" filename="name"/>
                                <field name="res_id" colspan="4" readonly="False" invisible="True"/>
                                <field name="res_model" colspan="4" readonly="False" invisible="True"/>

                            </form>
                        </field>
                        
                        <separator string="Messages" colspan="4" attrs="{'invisible': [('id', '=', False)]}" />

                        <field name="helpdesk_qa_ids" nolabel="1" class="ticket_messages" colspan="4"
                            attrs="{'readonly': [('proxy_status_code', 'in', ('xx','ok'))], 'invisible': [('id', '=', False)]}">

                            <tree string="Messagges List">
                                <field name="complete_message" string=""/>
                            </tree>
                            <form string="New Message">
                                <field name="date" readonly="1" colspan="4"/>
                                <field name="message" colspan="4"/>
                                <field name="complete_message" colspan="4" invisible="1"/>
                                <separator string="Attachments" colspan="4"/>
                                <field name="attachment_ids" colspan="4" mode="kanban" context="{'default_res_id':uid, 'default_res_model':'res.users'}">
                                    <form>
                                        <field name="name" colspan="4" invisible="True"/>
                                        <label for="datas" colspan="4"/>
                                        <field name="datas" colspan="4" filename="name"/>
                                        <field name="res_id" colspan="4" readonly="False" invisible="True"/>
                                        <field name="res_model" colspan="4" readonly="False" invisible="True"/>
                                    </form>
                                </field>
                            </form>
                        </field>
                        
                    </group>
                    
                    <group>
                        <field name="merge_ticket_id" readonly="1" colspan="4"
                               attrs="{'invisible':[('merge_ticket_id', '=', False)]}"
                               context="{'form_view_ref':'enhanced_helpdesk.enhanced_helpdesk_form'}"/>
                        <field name="merge_ticket_ids" colspan="4" readonly="1"
                               attrs="{'invisible':[('merge_ticket_ids', '=', [])]}">
                            <tree string="Merge">
                                <field name="id" string="#" />
                                <field name="name" string="Titolo" />
                                <field name="date" string="Date"/>
                            </tree>
                        </field>
                    </group>

                </sheet>
            </form>
        </field>
    </record>

    <!-- form per utenti BO -->
    <record id="enhanced_helpdesk_form_support" model="ir.ui.view">
        <field name="name">Enhanced HelpDesk Form</field>
        <field name="model">crm.helpdesk</field>
        <field name="inherit_id" ref="enhanced_helpdesk_form" />    
        <field name="groups_id" eval="[(4, [ref('enhanced_helpdesk.ticketing_support') ])]" /> 

        <field name="arch" type="xml">
        
                <xpath expr="//header" position="replace">
        
                    <header>
                    
                        <field name="ticket_status_id" widget="statusbar" attrs="{'readonly':True}" statusbar_colors="{&quot;5&quot;:&quot;blue&quot;}" /> 

                        <button class="oe_highlight" type="action"
                            name="%(action_ticket_reply)d"
                            string="Ticket Reply"
                            context="{'default_ticket_id': id}" />
                        
                        <button name="ticket_deleted" class="" string="Cancel ticket" confirm="Are you sure you want to cancel this ticket?"
                                attrs="{'invisible': ['|',('id', '=', False), ('proxy_status_code', 'in', ('wrk', 'dlv', 'ok', 'xx'))]}" />

                        <!-- disabled
                        <button name="%(action_change_ticket_user)d" class="oe_read_only" ticket_status_id="3"
                                string="Change User" type="action" groups="enhanced_helpdesk.ticketing_support"/> 
                                
                        <button name="%(action_merge_ticket)d" class="oe_read_only" ticket_status_id="3"
                                string="Merge Tickets" type="action" groups="enhanced_helpdesk.ticketing_support"/>
                        -->
                    </header>
                    
                </xpath>
                
                <xpath expr="//field[@name='project_id']" position="attributes">
                    <attribute name="widget">many2one</attribute>
                    <!-- temporaneo: da rendere dipendente da request_id -->
                    <attribute name="domain">[
                     ('privacy_visibility', 'in', ['portal'])
                    ]
                    </attribute>
                </xpath>
                
                <xpath expr="//field[@name='date']" position="attributes">
                    <attribute name="attrs">{'readonly': [('id', '!=', False)]}</attribute>
                </xpath>
                
                <xpath expr="//field[@name='request_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('id', '!=', False)]}</attribute>
                </xpath>
                
            
        </field>
    </record>

    <record id="search_enhanced_helpdesk" model="ir.ui.view">
        <field name="name">Enhanced Helpdesk</field>
        <field name="model">crm.helpdesk</field>
        <field name="type">search</field>
        <field name="arch" type="xml">  
            <search string="Tickets">
                <field name="id" />
                <field name="name" />
                <field name="project_id" />
                <field name="categ_id" />
                <field name="description" />
                <field name="date" />
                <filter name="filter_new" domain="[('proxy_status_code', '=', 'new')]" string="New"/> 
                <filter name="filter_assigned" domain="[('proxy_status_code', '=', 'ass')]" string="Assigned"/>
                <filter name="filter_pending" domain="[('proxy_status_code', '=', 'app')]" string="Pending"/>
                <filter name="filter_working" domain="[('proxy_status_code', '=', 'wrk')]" string="Working"/>
                <filter name="filter_delivered" domain="[('proxy_status_code', '=', 'dlv')]" string="Delivered"/>
                <filter name="filter_done" domain="[('proxy_status_code', '=', 'ok')]" string="Completed"/>
                <filter name="filter_cancel" domain="[('proxy_status_code', '=', 'xx')]" string="Cancel"/>
            </search>
        </field>
    </record>

    <record model="ir.actions.act_window" id="action_enhanced_helpdesk">
        <field name="name">Ticketing / Supporto</field>
        <field name="res_model">crm.helpdesk</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="view_id" ref="enhanced_helpdesk_kanban"/>
        <field name="search_view_id" ref="search_enhanced_helpdesk"/>
        <field name="context">{'needaction_menu_ref':1,
            'form_view_ref':'enhanced_helpdesk.enhanced_helpdesk_form',
            'search_default_filter_new':1,
            'search_default_filter_assigned':1,
            'search_default_filter_pending':1,
            'search_default_filter_working':1,
            'search_default_filter_delivered':1
        }</field>  
    </record>

   
    <!-- INHERITH VIEW TO INSERT NEW MESSAGE FORM -->
    <record id="crm_case_form_view_helpdesk_question_answer" model="ir.ui.view">
        <field name="name">crm.case.form.view.qa</field>
        <field name="model">crm.helpdesk</field>
        <field name="inherit_id" ref="crm_helpdesk.crm_case_form_view_helpdesk"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook/page[@string='General']" position="after">
            <page string="Comunicazioni">
                <field name="helpdesk_qa_ids" nolabel="1" class="ticket_messages" colspan="4">
                    <tree string="Messagges List">
                        <field name="complete_message"/>
                    </tree>
                    <form string="New Message">
                        <field name="date" readonly="1" colspan="4"/>
                        <field name="message" colspan="4"/>
                        <separator string="Attachments" colspan="4"/>
                        <field name="attachment_ids" colspan="4" mode="kanban">
                            <form>
                                <field name="name" colspan="4" invisible="True"/>
                                <label for="datas" colspan="4"/>
                                <field name="datas" colspan="4" filename="name"/>
                            </form>
                        </field>
                    </form>
                </field>
            </page>
            </xpath>
        </field>
    </record>

    <!-- Section for Support users -->
    <record id="support_enhanced_helpdesk_tree" model="ir.ui.view">
        <field name="name">Support Enhanced HelpDesk Tree</field>
        <field name="model">crm.helpdesk</field>
        <field name="arch" type="xml">
            
            <tree string="Helpdesk Support Tree"
                    colors="red:proxy_status_code in ('new','ass');black:proxy_status_code in ('wrk','dlv');blue:proxy_status_code=='app';green:proxy_status_code in ('ok');grey:proxy_status_code in ('xx')">
                <field name="id" string="#" />
                <field name="request_id" />
                <field name="name" string="Title" />
                <field name="date" string="Date"/>
                <field name="user_id"/>
                <field name="ticket_status_id"/>
                <field name="priority"/> 
                <field name="proxy_status_code" invisible="1" />

            </tree>
        </field>
    </record> 
       
</data>
</openerp>
